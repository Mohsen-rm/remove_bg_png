{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="app-card">
    <h2 class="app-title">ุฑูุน ุงูุตูุฑุฉ</h2>
    
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">
          {% for msg in messages %}{{ msg }}<br>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    
    <div id="upload-area" class="upload-area">
      <div class="upload-icon">๐</div>
      <p class="upload-text">ุงุณุญุจ ุงูุตูุฑุฉ ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
      <input type="file" id="file-input" accept="image/*">
      <button class="upload-btn">ุงุฎุชุฑ ุตูุฑุฉ</button>
    </div>

    <div class="preview-container hidden" id="preview-container">
      <div class="preview-box">
        <div class="preview-header">ุงูุตูุฑุฉ ุงูุฃุตููุฉ</div>
        <div class="preview-image-container">
          <img id="original-preview" class="preview-image">
        </div>
      </div>
      <div class="preview-box">
        <div class="preview-header">ุจุนุฏ ุฅุฒุงูุฉ ุงูุฎูููุฉ</div>
        <div class="preview-image-container" id="result-bg-container">
          <img id="result-preview" class="preview-image hidden">
          <div id="processing-indicator" class="hidden">
            <div class="loading-spinner"></div>
            <p>ุฌุงุฑู ุงููุนุงูุฌุฉ...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="controls hidden" id="controls">
      <h3>ุฅุนุฏุงุฏุงุช ุงูุฎูููุฉ ุงูุฌุฏูุฏุฉ</h3>
      
      <div class="control-group">
        <label class="control-label">ุงุฎุชุฑ ููุน ุงูุฎูููุฉ:</label>
        <div class="control-options">
          <label class="radio-label">
            <input type="radio" name="bg-type" value="transparent" checked>
            ุดูุงูุฉ
          </label>
          <label class="radio-label">
            <input type="radio" name="bg-type" value="color">
            ููู
          </label>
          <label class="radio-label">
            <input type="radio" name="bg-type" value="image">
            ุตูุฑุฉ
          </label>
        </div>
      </div>

      <div class="control-group hidden" id="color-control">
        <label class="control-label">ุงุฎุชุฑ ุงูููู:</label>
        <input type="color" id="bg-color" class="color-picker" value="#ffffff">
      </div>

      <div class="control-group hidden" id="image-control">
        <label class="control-label">ุตูุฑุฉ ุงูุฎูููุฉ:</label>
        <input type="file" id="bg-image-file" accept="image/*" class="bg-image-input">
      </div>

      <button id="process-btn" class="process-btn">
        ูุนุงูุฌุฉ ุงูุตูุฑุฉ
        <span id="process-spinner" class="loading-spinner hidden"></span>
      </button>

      <a id="download-btn" class="download-btn hidden" download="processed_image.png">ุชุญููู ุงูุตูุฑุฉ</a>
    </div>
  </div>

  <div class="app-card">
    <h2 class="app-title">ูููุฒุงุช ุงูุชุทุจูู</h2>
    <ul class="feature-list">
      <li class="feature-item"><span class="feature-icon">โ</span> ุฅุฒุงูุฉ ุฎูููุฉ ุงูุตูุฑุฉ ุจุฏูุฉ ุนุงููุฉ</li>
      <li class="feature-item"><span class="feature-icon">โ</span> ุฅููุงููุฉ ุฅุถุงูุฉ ุฎูููุฉ ุดูุงูุฉ</li>
      <li class="feature-item"><span class="feature-icon">โ</span> ุฅููุงููุฉ ุฅุถุงูุฉ ุฎูููุฉ ุจููู ูุญุฏุฏ</li>
      <li class="feature-item"><span class="feature-icon">โ</span> ุฅููุงููุฉ ุฅุถุงูุฉ ุตูุฑุฉ ูุฎูููุฉ</li>
      <li class="feature-item"><span class="feature-icon">โ</span> ูุงุฌูุฉ ูุณุชุฎุฏู ุณููุฉ ูุจุณูุทุฉ</li>
      <li class="feature-item"><span class="feature-icon">โ</span> ูุนุงูุฌุฉ ุณุฑูุนุฉ ููุตูุฑ</li>
      <li class="feature-item"><span class="feature-icon">โ</span> ุฏุนู ุงููุถุน ุงููุธูู</li>
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ุงูุนูุงุตุฑ
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');
  const uploadBtn = document.querySelector('.upload-btn');
  const previewContainer = document.getElementById('preview-container');
  const originalPreview = document.getElementById('original-preview');
  const resultPreview = document.getElementById('result-preview');
  const resultBgContainer = document.getElementById('result-bg-container');
  const controlsSection = document.getElementById('controls');
  const processingIndicator = document.getElementById('processing-indicator');
  const processBtn = document.getElementById('process-btn');
  const processSpinner = document.getElementById('process-spinner');
  const downloadBtn = document.getElementById('download-btn');

  // ุนูุงุตุฑ ุงูุฎูููุฉ
  const bgTypeRadios = document.querySelectorAll('input[name="bg-type"]');
  const colorControl = document.getElementById('color-control');
  const imageControl = document.getElementById('image-control');
  const bgColorPicker = document.getElementById('bg-color');
  const bgImageFile = document.getElementById('bg-image-file');

  let originalImage = null;
  let processedImage = null;
  let processedFileId = null; // ูุนุฑู ุงูููู ุงููุนุงูุฌ

  // ูุนุงูุฌุฉ ุงูุฑูุน
  uploadBtn.addEventListener('click', () => {
    fileInput.click();
  });

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('active');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('active');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('active');

    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      handleFileSelect();
    }
  });

  fileInput.addEventListener('change', handleFileSelect);

  function handleFileSelect() {
    if (fileInput.files && fileInput.files[0]) {
      const file = fileInput.files[0];

      // ุงูุชุญูู ูู ููุน ุงูููู
      if (!file.type.match('image.*')) {
        showFlash('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู ุตูุฑุฉ ุตุงูุญ');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        originalImage = e.target.result;
        originalPreview.src = originalImage;
        previewContainer.classList.remove('hidden');
        controlsSection.classList.remove('hidden');
        resultPreview.classList.add('hidden');
        processingIndicator.classList.add('hidden');
        downloadBtn.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }
  }

  // ุงุฎุชูุงุฑ ููุน ุงูุฎูููุฉ
  bgTypeRadios.forEach(radio => {
    radio.addEventListener('change', updateControlsVisibility);
  });

  function updateControlsVisibility() {
    const selectedType = document.querySelector('input[name="bg-type"]:checked').value;

    colorControl.classList.add('hidden');
    imageControl.classList.add('hidden');

    if (selectedType === 'color') {
      colorControl.classList.remove('hidden');
    } else if (selectedType === 'image') {
      imageControl.classList.remove('hidden');
    }
  }

  // ูุนุงูุฌุฉ ุงูุตูุฑุฉ
  processBtn.addEventListener('click', processImage);

  function processImage() {
    if (!originalImage) {
      showFlash('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุตูุฑุฉ ุฃููุงู');
      return;
    }

    // ุฅุธูุงุฑ ุงููุคุดุฑ
    resultPreview.classList.add('hidden');
    processingIndicator.classList.remove('hidden');
    processBtn.disabled = true;
    processSpinner.classList.remove('hidden');

    // ุฅูุดุงุก ุจูุงูุงุช ุงููููุฐุฌ
    const formData = new FormData();

    // ุฅุถุงูุฉ ุงูุตูุฑุฉ
    if (fileInput.files[0]) {
      formData.append('image', fileInput.files[0]);
    } else {
      // ุฅุฐุง ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุงุณุทุฉ ุงูุณุญุจ ูุงูุฅููุงุช
      formData.append('image_data', originalImage);
    }

    // ุฅุถุงูุฉ ููุน ุงูุฎูููุฉ
    const bgType = document.querySelector('input[name="bg-type"]:checked').value;
    formData.append('bg_type', bgType);

    // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุฎูููุฉ ุญุณุจ ุงูููุน
    if (bgType === 'color') {
      formData.append('bg_color', bgColorPicker.value);
    } else if (bgType === 'image' && bgImageFile.files[0]) {
      formData.append('bg_image', bgImageFile.files[0]);
    }

    // ุฅุฑุณุงู ุงูุทูุจ ูููุนุงูุฌุฉ
    fetch('/process', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // ุฅุธูุงุฑ ุงูุตูุฑุฉ ุงูููุงุฆูุฉ
        processedImage = data.image;
        processedFileId = data.file_id; // ุชุฎุฒูู ูุนุฑู ุงูููู
        resultPreview.src = processedImage;
        resultPreview.classList.remove('hidden');
        downloadBtn.classList.remove('hidden');

        // ุชุญุฏูุซ ุฑุงุจุท ุงูุชุญููู
        downloadBtn.href = `/download/${processedFileId}`;
      } else {
        showFlash(data.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showFlash('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ');
    })
    .finally(() => {
      // ุฅุฎูุงุก ุงููุคุดุฑ
      processingIndicator.classList.add('hidden');
      processBtn.disabled = false;
      processSpinner.classList.add('hidden');
    });
  }

  // ุฑุณุงุฆู ุงูุฎุทุฃ
  function showFlash(message) {
    const flashContainer = document.createElement('div');
    flashContainer.className = 'flash';
    flashContainer.textContent = message;

    const container = document.querySelector('.app-card');
    container.insertBefore(flashContainer, container.firstChild.nextSibling);

    setTimeout(() => {
      flashContainer.remove();
    }, 5000);
  }
});
</script>
{% endblock %}